# BATCH-04.1: Fix Network Migration Tests

**Batch Number:** BATCH-04.1 (Corrective)  
**Parent Batch:** BATCH-04  
**Estimated Effort:** 2 Hours  
**Priority:** HIGH (Corrective)  

---

## ðŸ“‹ Onboarding & Workflow

### Background
BATCH-04 moved the code, but broke the tests. The `ReliableInitializationScenarios` test relies on `internal` methods of `EntityLifecycleModule` (`ProcessConstructionAck`) which are not accessible from the new test project.
The developer commented out the failing lines, causing the tests to be meaningless (false positives) or fail compilation.

### Objective
Fix the tests to use the PUBLIC API (`LifecycleSystem`) instead of internal methods.

---

## âœ… Tasks

### Task 1: Fix ReliableInitializationScenarios.cs
**Goal:** Restore the test logic using correct systems.

**Specs:**
1.  Open `ModuleHost.Network.Cyclone.Tests/Integration/ReliableInitializationScenarios.cs`.
2.  **Refactor `ProcessAcks` method:**
    - **OLD (Broken):** Manually consumes events and calls `elm.ProcessConstructionAck`.
    - **NEW (Correct):** Instantiate `LifecycleSystem` and call `Execute`.
    ```csharp
    private void ProcessAcks(EntityRepository repo, EntityLifecycleModule elm)
    {
        // 1. Swap buffers so published events (ConstructionAck) become visible
        repo.Bus.SwapBuffers();
        
        // 2. Use the System to process them (Public API)
        var sys = new LifecycleSystem(elm);
        sys.Execute(repo, 0f); // This consumes events and calls internal logic
        
        // 3. Playback commands generated by the system (e.g. SetLifecycleState)
        var cmd = ((ISimulationView)repo).GetCommandBuffer();
        ((EntityCommandBuffer)cmd).Playback(repo);
    }
    ```
3.  **Remove** any `// TODO: FIX MIGRATION` comments. Code must be active.

---

### Task 2: Verify All Migrated Tests
**Goal:** Ensure all 13 moved test files compile and pass.

**Specs:**
1.  Run `dotnet test ModuleHost.Network.Cyclone.Tests`.
2.  Watch for errors related to `NodeIdMapper` dummy injection. Ensure they work.
3.  **Requirement:** 0 Failures. 0 Skipped tests.

---

## ðŸ§ª Testing Requirements

**Success Criteria:**
1.  `ReliableInitializationScenarios` passes **WITHOUT** commented-out logic.
2.  Build is clean (no errors).

**Deliverable:**
- A working `ModuleHost.Network.Cyclone` plugin with a passing test suite.
